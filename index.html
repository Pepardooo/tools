<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contador de Tiempo de Render</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{color-scheme: light dark}
    body{font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    .label{letter-spacing:.08em;text-transform:uppercase}
    .num{tab-size:2; font-variant-numeric: tabular-nums}
  </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen p-6">
  <div class="max-w-6xl mx-auto grid gap-6 md:grid-cols-[520px_1fr] items-start">

    <!-- Card -->
    <section class="bg-white rounded-3xl shadow-xl border border-slate-100 p-6">
      <div id="card" class="relative overflow-hidden rounded-2xl border border-slate-200">
        <div class="absolute inset-0 pointer-events-none bg-gradient-to-br from-indigo-50 to-white"></div>
        <div class="relative p-6 flex flex-col gap-5">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-xl bg-indigo-600 text-white grid place-items-center text-xl">üñ•Ô∏è</div>
              <div>
                <div id="projName" class="text-lg font-extrabold">Proyecto</div>
                <div id="startInfo" class="text-slate-600 text-sm">‚Äî</div>
              </div>
            </div>
            <div class="text-right">
              <div class="label text-[10px] text-slate-500">M√°quinas</div>
              <div id="machinesShow" class="font-semibold num">1</div>
            </div>
          </div>

          <!-- Totals -->
          <div class="grid grid-cols-3 gap-3">
            <div class="rounded-2xl border border-slate-200 bg-white p-4">
              <div class="label text-[10px] text-slate-500">Frames totales</div>
              <div id="totalFrames" class="text-2xl font-extrabold num">0</div>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-4">
              <div class="label text-[10px] text-slate-500">Tiempo estimado</div>
              <div id="totalTime" class="text-2xl font-extrabold num">00:00:00</div>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-4">
              <div class="label text-[10px] text-slate-500">ETA (fin)</div>
              <div id="eta" class="text-2xl font-extrabold num">‚Äî</div>
            </div>
          </div>

          <!-- Progress -->
          <div class="mt-2">
            <div class="flex items-center justify-between text-sm text-slate-600 mb-1">
              <span class="label text-[10px]">Progreso</span>
              <span class="num" id="progressPct">0%</span>
            </div>
            <div class="h-3 bg-slate-200 rounded-full overflow-hidden">
              <div id="bar" class="h-full bg-indigo-600 rounded-full" style="width:0%"></div>
            </div>
            <div class="flex items-center justify-between text-sm text-slate-600 mt-1">
              <span class="num" id="doneFrames">0</span>
              <span class="num" id="remainingFrames">0</span>
            </div>
          </div>

          <!-- Links / Share -->
          <div class="flex flex-wrap gap-2 pt-1">
            <button id="copyLink" class="px-3 py-2 rounded-xl border border-indigo-200 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 font-semibold text-sm">Copiar link con par√°metros</button>
            <button id="openLink" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-slate-800 font-semibold text-sm">Abrir link</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Editor -->
    <section class="bg-white rounded-3xl shadow-xl border border-slate-100 p-6">
      <h2 class="font-bold text-lg mb-3">Par√°metros de render</h2>
      <div class="grid sm:grid-cols-2 gap-4">
        <div class="sm:col-span-2">
          <label class="label text-[10px] text-slate-500">Nombre del proyecto</label>
          <input id="f-name" class="w-full px-3 py-2 rounded-xl border border-slate-200" placeholder="Dalstrong GOT ‚Äì Drogon"/>
        </div>
        <div>
          <label class="label text-[10px] text-slate-500">M√°quinas en paralelo</label>
          <input id="f-machines" type="number" min="1" class="w-full px-3 py-2 rounded-xl border border-slate-200" value="1"/>
        </div>
        <div>
          <label class="label text-[10px] text-slate-500">Inicio</label>
          <input id="f-start" type="datetime-local" class="w-full px-3 py-2 rounded-xl border border-slate-200"/>
        </div>
      </div>

      <h3 class="font-semibold mt-5 mb-2">Shots / bloques</h3>
      <div id="shots" class="space-y-3"></div>
      <button id="addShot" class="mt-3 px-3 py-2 rounded-xl bg-slate-900 text-white font-semibold">Agregar bloque</button>

      <h3 class="font-semibold mt-6 mb-2">Progreso</h3>
      <div class="grid sm:grid-cols-3 gap-3">
        <div>
          <label class="label text-[10px] text-slate-500">Frames completados</label>
          <input id="f-done" type="number" min="0" class="w-full px-3 py-2 rounded-xl border border-slate-200" value="0"/>
        </div>
        <div class="sm:col-span-2">
          <label class="label text-[10px] text-slate-500">Notas</label>
          <input id="f-notes" class="w-full px-3 py-2 rounded-xl border border-slate-200" placeholder="Ej: subir a Drive al terminar, revisar fireflies en planos 12‚Äì24"/>
        </div>
      </div>

      <div class="flex flex-wrap gap-3 mt-5">
        <button id="apply" class="px-4 py-2 rounded-xl bg-indigo-600 text-white font-semibold">Aplicar / Recalcular</button>
        <button id="now" class="px-4 py-2 rounded-xl bg-white border border-slate-200 font-semibold">Empezar ahora</button>
      </div>

      <p class="text-xs text-slate-500 mt-3">Tip: cada bloque permite cargar **frames** y **tiempo por frame** (en segundos o mm:ss). Pod√©s duplicar bloques para planos con tiempos distintos. El c√°lculo divide entre la cantidad de m√°quinas en paralelo.</p>
    </section>
  </div>

  <template id="shotTpl">
    <div class="rounded-2xl border border-slate-200 p-3">
      <div class="grid sm:grid-cols-4 gap-3 items-end">
        <div>
          <label class="label text-[10px] text-slate-500">Nombre</label>
          <input class="shot-name w-full px-3 py-2 rounded-xl border border-slate-200" placeholder="Plano 01" />
        </div>
        <div>
          <label class="label text-[10px] text-slate-500">Frames</label>
          <input class="shot-frames w-full px-3 py-2 rounded-xl border border-slate-200" type="number" min="0" value="100" />
        </div>
        <div>
          <label class="label text-[10px] text-slate-500">Tiempo/frame</label>
          <input class="shot-spf w-full px-3 py-2 rounded-xl border border-slate-200" placeholder="seg o mm:ss" value="15" />
        </div>
        <div class="flex gap-2">
          <button class="dup px-3 py-2 rounded-xl bg-white border border-slate-200 font-semibold flex-1">Duplicar</button>
          <button class="del px-3 py-2 rounded-xl bg-rose-600 text-white font-semibold">Eliminar</button>
        </div>
      </div>
    </div>
  </template>

  <script>
    const $ = (id) => document.getElementById(id);
    const nf = new Intl.NumberFormat();

    function parseSpf(v){
      v = (v||'').trim();
      if(!v) return 0;
      if(v.includes(':')){
        const [m,s] = v.split(':').map(Number);
        return (m||0)*60 + (s||0);
      }
      const n = Number(v.replace(',', '.'));
      return isNaN(n)?0:n; // seconds
    }

    function fmtHMS(sec){
      sec = Math.max(0, Math.round(sec));
      const h = Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60;
      return [h,m,s].map(x=>String(x).padStart(2,'0')).join(':');
    }

    function isoLocal(dt){
      // human-friendly like: lun 12 ago, 17:20
      try{
        return new Intl.DateTimeFormat('es-AR',{weekday:'short',day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}).format(dt);
      }catch(e){ return dt.toLocaleString(); }
    }

    function collectShots(){
      const rows = [...document.querySelectorAll('#shots > .rounded-2xl')];
      return rows.map(row=>({
        name: row.querySelector('.shot-name').value.trim(),
        frames: Number(row.querySelector('.shot-frames').value||0),
        spf: parseSpf(row.querySelector('.shot-spf').value)
      }));
    }

    function totalFrames(shots){ return shots.reduce((a,b)=>a+(b.frames||0),0); }
    function totalSeconds(shots, machines){
      const sum = shots.reduce((a,b)=>a + (b.frames||0)*(b.spf||0), 0);
      return sum / Math.max(1, machines||1);
    }

    function fillFromQuery(){
      const p = new URLSearchParams(location.search);
      if(p.get('name')) $('f-name').value = p.get('name');
      if(p.get('machines')) $('f-machines').value = p.get('machines');
      if(p.get('start')) $('f-start').value = p.get('start');
      if(p.get('done')) $('f-done').value = p.get('done');
      if(p.get('notes')) $('f-notes').value = p.get('notes');
      const shots = p.getAll('shot'); // multiple entries allowed: frames,spf,name
      if(shots.length){
        $('shots').innerHTML='';
        for(const s of shots){
          const [frames, spf, name] = s.split('|');
          addShot({frames, spf, name});
        }
      }
    }

    function toQuery(){
      const p = new URLSearchParams();
      p.set('name',$('f-name').value.trim());
      p.set('machines',$('f-machines').value.trim());
      if($('f-start').value) p.set('start',$('f-start').value);
      if($('f-done').value) p.set('done',$('f-done').value);
      if($('f-notes').value) p.set('notes',$('f-notes').value.trim());
      for(const {name,frames,spf} of collectShots()){
        p.append('shot', `${frames}|${spf}|${name||''}`);
      }
      return p.toString();
    }

    function addShot(prefill){
      const tpl = document.getElementById('shotTpl');
      const node = tpl.content.cloneNode(true);
      const el = node.querySelector('.rounded-2xl');
      if(prefill){
        el.querySelector('.shot-name').value = prefill.name||'';
        el.querySelector('.shot-frames').value = prefill.frames||0;
        el.querySelector('.shot-spf').value = prefill.spf||'';
      }
      el.querySelector('.dup').addEventListener('click',()=>{
        addShot({
          name: el.querySelector('.shot-name').value,
          frames: el.querySelector('.shot-frames').value,
          spf: el.querySelector('.shot-spf').value
        });
      });
      el.querySelector('.del').addEventListener('click',()=>{
        el.remove();
      });
      document.getElementById('shots').appendChild(node);
    }

    function recalc(){
      const name = $('f-name').value.trim()||'Proyecto';
      const machines = Number($('f-machines').value||1);
      const startStr = $('f-start').value;
      const done = Number($('f-done').value||0);
      const shots = collectShots();

      const tFrames = totalFrames(shots);
      const secs = totalSeconds(shots, machines);

      $('projName').textContent = name;
      $('machinesShow').textContent = machines;
      $('totalFrames').textContent = nf.format(tFrames);
      $('totalTime').textContent = fmtHMS(secs);

      const remainingFrames = Math.max(0, tFrames - done);
      $('doneFrames').textContent = `Hechos: ${nf.format(done)}`;
      $('remainingFrames').textContent = `Restan: ${nf.format(remainingFrames)}`;

      const pct = tFrames>0 ? Math.min(100, Math.round(done*100/tFrames)) : 0;
      $('progressPct').textContent = pct + '%';
      $('bar').style.width = pct + '%';

      // ETA
      let etaText = '‚Äî';
      if(startStr){
        const start = new Date(startStr);
        const perFrame = tFrames>0 ? secs / tFrames : 0; // seconds per frame overall (after machines)
        const remainingSecs = Math.max(0, remainingFrames * perFrame);
        const eta = new Date(Date.now() + remainingSecs*1000);
        etaText = isoLocal(eta);
      }
      $('eta').textContent = etaText;

      // Notes shown under progress bar? reuse notes inside card footer later if needed
      const notes = $('f-notes').value.trim();
      const notesEl = document.createElement('div');
      notesEl.className = 'mt-2 text-sm text-slate-600';
      notesEl.textContent = notes;
    }

    // Buttons
    $('addShot').addEventListener('click', ()=> addShot());
    $('apply').addEventListener('click', recalc);
    $('now').addEventListener('click', ()=>{
      const now = new Date();
      const pad = (n)=> String(n).padStart(2,'0');
      const local = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
      $('f-start').value = local;
      recalc();
    });

    $('copyLink').addEventListener('click', async ()=>{
      const url = location.origin + location.pathname + '?' + toQuery();
      try{ await navigator.clipboard.writeText(url); alert('Link copiado'); } catch(e){ prompt('Copi√° el link:', url); }
    });
    $('openLink').addEventListener('click', ()=>{
      const url = location.origin + location.pathname + '?' + toQuery();
      window.open(url,'_blank');
    });

    // Init: one shot by default
    addShot({name:'Plano 01', frames:100, spf:'15'});
    fillFromQuery();
    // Mostrar inicio
    setInterval(()=>{
      const v=$('f-start').value; $('startInfo').textContent = v? ('Inicio: '+ v.replace('T',' ')) : '‚Äî';
    },500);

  </script>
</body>
</html>
